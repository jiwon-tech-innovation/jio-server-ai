apiVersion: apps/v1
kind: Deployment
metadata:
  name: jiaa-server-ai
  namespace: jiaa
  labels:
    app: jiaa-server-ai
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jiaa-server-ai
  template:
    metadata:
      labels:
        app: jiaa-server-ai
    spec:
      serviceAccountName: jiaa-server-ai
      containers:
      - name: jiaa-server-ai
        image: 541673202749.dkr.ecr.ap-northeast-2.amazonaws.com/jiaa-server-ai:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 8000
          name: http
        - containerPort: 50051
          name: grpc
        env:
        # General Config
        - name: PROJECT_NAME
          value: "JIAA Intelligence Worker"
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: jiaa-ai-secret
              key: openai_api_key
        - name: GROQ_API_KEY
          valueFrom:
            secretKeyRef:
              name: jiaa-groq-secret
              key: groq_api_key
        
        # AWS Credentials (Recommended: Use IRSA instead of keys)
        # - name: AWS_ACCESS_KEY_ID
        #   valueFrom: { secretKeyRef: { name: aws-secret, key: key_id } }
        # - name: AWS_SECRET_ACCESS_KEY
        #   valueFrom: { secretKeyRef: { name: aws-secret, key: access_key } }
        - name: BEDROCK_REGION
          value: "us-east-1"
        - name: AWS_REGION
          value: "us-east-1"
        
        # Database (Connects to 'jiaa-postgres' Service)
        # Database (Connects to RDS directly based on prod env)
        - name: PG_HOST
          value: "jiaa-db.cveg64k8yuia.ap-northeast-2.rds.amazonaws.com"
        - name: PG_PORT
          value: "5432"
        - name: PG_USER
          valueFrom:
            secretKeyRef:
              name: jiaa-db-secret
              key: pg_user
        - name: PG_PASSWORD
          valueFrom:
            secretKeyRef:
              name: jiaa-db-secret
              key: pg_password
        - name: PG_DB
          value: "jiaa" # Config says jiaa_memory but env says jiaa. using env.
        
        # Redis (Connects to 'redis-master' in 'jiaa-system')
        - name: REDIS_HOST
          value: "redis-master.jiaa-system.svc.cluster.local"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: jiaa-redis-secret
              key: password
        
        # InfluxDB (Connects to 'jiaa-influxdb' Service)
        - name: INFLUXDB_URL
          value: "http://jiaa-influxdb:8086"
        - name: INFLUXDB_ORG
          value: "jiaa"
        - name: INFLUXDB_BUCKET
          value: "sensor_data"
        - name: INFLUXDB_TOKEN
          valueFrom:
            secretKeyRef:
              name: jiaa-influx-secret
              key: token
        
        # Probes
        livenessProbe:
          httpGet:
            path: /
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 5
